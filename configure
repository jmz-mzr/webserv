#============================================ Intallation directory

INSTALLDIR="$HOME/.local"

#==================================================================

if [ "$1" = "-u" -o "$1" = "--uninstall" ]; then
	echo "Uninstalling \"webserv\""
	export PATH="$(echo "$PATH" | sed -e "s|${INSTALLDIR//|/\\|}/bin:||g")"
	echo -n "Deleting \"$INSTALLDIR\"? "
	read -r CONFIRM
	if [[ "${CONFIRM:0:1}" =~ ^[Yy]$ ]]; then
		rm -fr "$INSTALLDIR"
		echo "\"$INSTALLDIR\" has been removed"
	fi
	return
fi

ft_realpath() {
	[[ $1 = /* ]] && echo "$1" || echo "$PWD/${1#./}"
}

case $SHELL in
*/bash)
	export SELF_PATH="${BASH_SOURCE[0]}"
	;;
*)
	export SELF_PATH="$0"
esac

if [ -z "$INSTALLDIR" ]; then
	echo "Installation directory undefined, please open $SELF_PATH"
else
	export WORKDIR="$(dirname "$(ft_realpath "$SELF_PATH")")"
	WWWDIR=$WORKDIR/www
	CONF_FILE="$WORKDIR/default.conf"
	PLATFORM=$(uname -s)

	if [[ "$PLATFORM" = "Linux" ]]; then
		sed -i 's/macos/ubuntu/g' "$CONF_FILE"
	elif [[ "$PLATFORM" = "Darwin" ]]; then
		sed -i "" -e 's/ubuntu/macos/g' "$CONF_FILE"
	fi

	chmod +x $WWWDIR/webserv.42.fr/{index.php,index.pl,cgi-bin/info.php}
	chmod -R +x $WWWDIR/webserv.42.test/cgi-bin/
	chmod 1777 $WWWDIR/sessions

	if [ ! -d "$INSTALLDIR" ]; then
		echo "Creating \"$INSTALLDIR\" to install \"webserv\""
		mkdir -p "$INSTALLDIR"
	fi
	if [ ! -d "$INSTALLDIR" ]; then
		echo "\"$INSTALLDIR\" cannot be created, set another installation path"
	elif [ ! -w "$INSTALLDIR" ]; then
		echo "You do not have write permission on \"$INSTALLDIR\""
	else
		export PREFIX=$INSTALLDIR
		if [[ -z "$(echo "$PATH" | grep "$PREFIX/bin")" ]]; then
			export PATH="$PREFIX/bin:$PATH"
		fi
		echo "\"webserv\"'s installation directory is \"$INSTALLDIR\""
	fi
fi

unset SELF_PATH
