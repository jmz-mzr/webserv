#============================================ Intallation directory

INSTALLDIR="$HOME/.local"

#==================================================================

if [ "$1" = "-u" -o "$1" = "--uninstall" ]; then
	echo "Uninstalling \"webserv\""
    non_webserv_files=$(find "${INSTALLDIR}/bin" -mindepth 1 -maxdepth 1 \
		! -name "webserv" -print | wc -l | tr -d ' ')
    if [ "$non_webserv_files" = "0" ]; then
		PATH="$(echo "$PATH" | sed -e "s|${INSTALLDIR}/bin:||g")"
		export PATH
	fi
	unset WORKDIR
	unset PREFIX
	echo -n "Delete webserv related files in \"$INSTALLDIR/*\"? "
	read -r CONFIRM
	case "$CONFIRM" in
		[Yy]*)
			find "$INSTALLDIR" -path '*bin*' -name "webserv" -exec rm -i '{}' \;
			find "$INSTALLDIR" -depth \! -path '*share*' \! -path '*bin*' \( -name "sessions" -or -name "webserv*" \) -exec rm -rI '{}' \;
			find "$INSTALLDIR" -depth \! -path '*share*' -name "perl_cgi" -exec rm -r '{}' \;
			echo "Removing webserv related files in \"$INSTALLDIR\" done"
			;;
	esac
	return
fi

ft_realpath() {
	case "$1" in
		/*) echo "$1" ;;
		*) echo "$PWD/${1#./}" ;;
	esac
}

case $SHELL in
	*/bash)
		SELF_PATH="${BASH_SOURCE[0]}" ;;
	*)
		SELF_PATH="$0" ;;
esac
export SELF_PATH

if [ -z "$INSTALLDIR" ]; then
	echo "Installation directory undefined, please edit the '$SELF_PATH' file"
else
	WORKDIR="$(dirname "$(ft_realpath "$SELF_PATH")")"
	export WORKDIR
	WWWDIR=$WORKDIR/www
	CONF_FILE="$WORKDIR/default.conf"
	PLATFORM=$(uname -s)

 	case "$PLATFORM" in
		Linux)
			sed -i 's/macos/ubuntu/g' "$CONF_FILE" ;;
		Darwin)
			sed -i "" -e 's/ubuntu/macos/g' "$CONF_FILE" ;;
	esac

	chmod +x $WWWDIR/webserv.42.fr/{index.php,index.pl,cgi-bin/info.php}
	chmod -R +x $WWWDIR/webserv.42.test/cgi-bin/
	chmod 1777 $WWWDIR/sessions

	if [ ! -d "$INSTALLDIR" ]; then
		echo "Creating \"$INSTALLDIR\" to install \"webserv\""
		mkdir -p "$INSTALLDIR"
	fi
	if [ ! -d "$INSTALLDIR" ]; then
		echo "\"$INSTALLDIR\" cannot be created, set another installation path"
	elif [ ! -w "$INSTALLDIR" ]; then
		echo "You do not have write permission on \"$INSTALLDIR\""
	else
		PREFIX=$INSTALLDIR
		export PREFIX
		if [ -z "$(echo "$PATH" | grep "$PREFIX/bin")" ]; then
			PATH="$PREFIX/bin:$PATH"
			export PATH
		fi
		echo "\"webserv\"'s installation directory is \"$INSTALLDIR\""
	fi
fi

unset SELF_PATH
